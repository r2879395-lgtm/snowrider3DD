<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snow Rider 3D - Leaderboard Edition</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #111827; /* Dark background for the game */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Prevent scrolling */
        }
        
        /* Style to ensure Unity WebGL container is visible and full screen */
        #game-content-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            justify-content: center; /* Center the game container */
            align-items: center;
            /* --- MOVED RIGHT --- */
            transform: translateX(10vw); /* Shifts the entire game content 10% of the viewport width to the right */
        }

        /* --- Aspect Ratio Container (Fixes game scaling to 16:10) --- */
        #game-wrapper {
            /* Max size should be limited, maintaining a 16:10 aspect ratio */
            width: 100%;
            max-width: 1000px; /* Arbitrary max width to prevent excessive scaling */
            /* This padding trick keeps the ratio: 600/960 = 0.625 -> 62.5% */
            padding-top: 62.5%; 
            height: 0;
            position: relative;
            overflow: hidden;
            background-color: #000; /* Black background while loading */
        }

        #gameContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

    </style>

    <!-- Original Unity Game Scripts (UnityProgress.js and UnityLoader.js are the only things needed here) -->
    <script src="TemplateData/UnityProgress.js"></script>
    <script src="Build/UnityLoader.js"></script>
    
</head>

<body>

    <!-- Game Content Container -->
    <div id="game-content-container" class="relative">
        <!-- New wrapper to maintain aspect ratio -->
        <div id="game-wrapper" class="webgl-content"> 
            <div id="gameContainer"></div>
        </div>

        <!-- Leaderboard Overlay -->
        <div id="leaderboard-overlay" 
             class="absolute top-4 right-4 bg-white/80 backdrop-blur-sm p-4 rounded-xl shadow-2xl z-20 
                    w-72 md:w-80 border-t-4 border-blue-500 block">
            <h3 class="text-xl font-extrabold text-gray-800 mb-3 flex items-center">
                <svg class="w-6 h-6 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-9a1 1 0 00-2 0v5a1 1 0 002 0v-5zm4 0a1 1 0 10-2 0v5a1 1 0 102 0v-5zm-2-5a1 1 0 00-1 1v1a1 1 0 102 0V5a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                Top Snow Riders
            </h3>
            <div id="leaderboard-list" class="space-y-2 text-sm">
                <!-- Leaderboard items will be injected here -->
                <p class="text-gray-500 italic">Loading scores...</p>
            </div>
            <p id="score-status" class="mt-4 text-center text-xs font-medium text-gray-600">
                Play to submit your high score!
                <!-- Example: In console, call sendScoreToGame(300) -->
            </p>
        </div>
    </div>
    
    <!-- Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration for Self-Hosting (Replace with your own!) ---
        // Since the standard environment variables won't be available on GitHub, 
        // we use a default configuration block.
        const DEFAULT_FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY", // <<< REPLACE THIS
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // <<< REPLACE THIS
            projectId: "YOUR_PROJECT_ID", // <<< REPLACE THIS
            storageBucket: "YOUR_PROJECT_ID.appspot.com", // <<< REPLACE THIS
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // <<< REPLACE THIS
            appId: "YOUR_APP_ID" // <<< REPLACE THIS
        };
        // --- End Firebase Config ---

        // --- Global Firebase Setup ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'snowrider-leaderboard';
        
        let isFirebaseInitialized = false;
        let gameInstance = null;
        let currentUserId = 'Player-' + Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
        let currentUserName = currentUserId; 

        // Firestore Path Constants
        const SCORE_COLLECTION_PATH = `/artifacts/${appId}/public/data/scores`;
        
        // --- DOM Elements ---
        const leaderboardList = document.getElementById('leaderboard-list');
        const scoreStatus = document.getElementById('score-status');

        try {
            // Priority 1: Use the environment-provided config (if available)
            let firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            
            // Priority 2: If environment config is missing, use the hardcoded default config
            if (!firebaseConfig || !firebaseConfig.projectId || firebaseConfig.projectId === 'mock-project-id') {
                firebaseConfig = DEFAULT_FIREBASE_CONFIG;
                
                // If the default config is still using the placeholders, log a warning
                if (firebaseConfig.projectId === 'YOUR_PROJECT_ID') {
                    throw new Error("Hardcoded Firebase config placeholders are not replaced.");
                }
            }

            if (firebaseConfig && firebaseConfig.projectId) {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                isFirebaseInitialized = true;
                console.log("Firebase initialized successfully.");
            } else {
                throw new Error("No valid Firebase configuration found.");
            }
        } catch (e) {
            console.error("Critical error during Firebase initialization:", e);
            console.warn("Leaderboard functions will be disabled.");
            leaderboardList.innerHTML = '<p class="text-red-500 italic text-center">Leaderboard service unavailable.</p>';
            scoreStatus.textContent = 'Warning: Leaderboard services are currently disabled. Check console for setup instructions.';
        }

        // --- Helper Functions ---

        /**
         * Initializes and starts the Unity WebGL game.
         */
        function startGame() {
            if (gameInstance) return;

            // UnityLoader is loaded via a separate script tag in the head
            gameInstance = UnityLoader.instantiate("gameContainer", "Build/SnowRider3D-gd-1.json", { 
                onProgress: UnityProgress, 
                Module: { 
                    onRuntimeInitialized: function () { 
                        UnityProgress(gameInstance, "complete");
                    } 
                } 
            });
        }
        
        /**
         * Renders the leaderboard data.
         * @param {Array<Object>} scores List of score objects.
         */
        function renderLeaderboard(scores) {
            if (!isFirebaseInitialized) return; // Stop if not initialized

            leaderboardList.innerHTML = ''; // Clear previous scores
            
            if (scores.length === 0) {
                leaderboardList.innerHTML = '<p class="text-gray-500 italic text-center">No scores submitted yet. Be the first!</p>';
                return;
            }

            scores.forEach((scoreData, index) => {
                const rank = index + 1;
                const item = document.createElement('div');
                item.className = `flex justify-between items-center p-2 rounded-lg 
                                  ${rank === 1 ? 'bg-yellow-100 font-bold text-gray-900' : 'bg-white hover:bg-gray-50'}`;
                
                let rankIcon = `<span class="text-gray-500 w-5 text-center">${rank}</span>`;
                if (rank === 1) rankIcon = `<span class="text-yellow-500 w-5 text-center">ðŸ¥‡</span>`;
                else if (rank === 2) rankIcon = `<span class="text-gray-400 w-5 text-center">ðŸ¥ˆ</span>`;
                else if (rank === 3) rankIcon = `<span class="text-amber-600 w-5 text-center">ðŸ¥‰</span>`;

                item.innerHTML = `
                    <div class="flex items-center space-x-3">
                        ${rankIcon}
                        <span class="truncate max-w-[100px]">${scoreData.username || 'Anonymous'}</span>
                    </div>
                    <span class="text-lg font-extrabold text-blue-600">${scoreData.score}</span>
                `;
                leaderboardList.appendChild(item);
            });
        }
        
        // --- Firebase Interaction ---

        /**
         * Sets up the real-time listener for the leaderboard.
         */
        function setupLeaderboardListener() {
            if (!isFirebaseInitialized) return;
            
            // Note: This query assumes your Firestore security rules allow public read access 
            // to the /artifacts/{appId}/public/data/scores collection for unauthenticated users.
            const scoresQuery = query(collection(window.db, SCORE_COLLECTION_PATH));

            onSnapshot(scoresQuery, (snapshot) => {
                const scores = [];
                snapshot.forEach((doc) => {
                    scores.push(doc.data());
                });

                // 1. Sort the scores in memory
                scores.sort((a, b) => (b.score || 0) - (a.score || 0));
                
                // 2. Limit the scores to the top 5
                const topScores = scores.slice(0, 5);

                renderLeaderboard(topScores);
            }, (error) => {
                console.error("Leaderboard Snapshot Error:", error);
                leaderboardList.innerHTML = `<p class="text-red-500 text-center">Error loading leaderboard: check console.</p>`;
            });
        }
        
        /**
         * Saves a new score to Firestore.
         * @param {number} score 
         */
        async function saveScore(score) {
            if (!isFirebaseInitialized || score <= 0) {
                 scoreStatus.textContent = `Score submission failed (Leaderboard disabled).`;
                 return;
            }

            // Use the current user's ID as the document ID for overwriting their previous best score
            const userScoreRef = doc(window.db, SCORE_COLLECTION_PATH, currentUserId);
            
            try {
                // Fetch the existing score to check if the new score is better
                const existingDoc = await getDoc(userScoreRef); 
                const existingScore = existingDoc.exists() ? existingDoc.data().score : 0;

                if (score > existingScore) {
                    await setDoc(userScoreRef, {
                        userId: currentUserId,
                        username: currentUserName,
                        score: score,
                        timestamp: Date.now() 
                    }, { merge: true });

                    scoreStatus.textContent = `NEW High Score: ${score}!`;
                } else {
                    scoreStatus.textContent = `Score of ${score} not higher than your best of ${existingScore}.`;
                }
            } catch (error) {
                console.error("Score submission error:", error);
                scoreStatus.textContent = `Error submitting score. (Score: ${score})`;
            }
        }
        
        // --- Exposed Global Function (Simulated Game Callback) ---
        
        /**
         * Global function that the Unity game would theoretically call 
         * when the player gets a new high score.
         * @param {string} scoreString The score sent from the game as a string.
         */
        window.sendScoreToGame = (scoreString) => {
            const score = parseInt(scoreString, 10);
            if (!isNaN(score) && score > 0) {
                console.log(`Received new score from game: ${score}`);
                saveScore(score);
            }
        };

        // --- Initialization ---
        
        /**
         * Handles Firebase authentication and starts the leaderboard listener.
         */
        async function initializeFirebase() {
            if (!isFirebaseInitialized) {
                 return;
            }
            
            // 1. Authenticate (Anonymously or with token)
            try {
                // Use custom token if available (for Canvas environment)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    // Sign in anonymously (for GitHub / self-hosted environments)
                    await signInAnonymously(window.auth);
                }
                currentUserId = window.auth.currentUser.uid;
                // Update username to reflect signed-in status
                currentUserName = `Rider-${currentUserId.substring(0, 4)}`;
                scoreStatus.textContent = `Signed in as ${currentUserName}. Play to submit your score!`;
                
                console.log("Firebase Auth: Signed in as:", currentUserName);
            } catch (error) {
                console.error("Firebase Authentication Error:", error);
                scoreStatus.textContent = 'Warning: Could not authenticate with scoreboard services.';
                isFirebaseInitialized = false; // Disable if auth fails
                renderLeaderboard([]);
                return;
            }
            
            // 2. Start the real-time leaderboard listener
            setupLeaderboardListener();
        }

        // Start the game immediately on DOM load
        document.addEventListener('DOMContentLoaded', () => {
            // Step 1: Start the game first
            startGame();
            // Step 2: Initialize Firebase (asynchronously, non-blocking)
            initializeFirebase();
        });

    </script>
</body>
</html>
